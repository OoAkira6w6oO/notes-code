# Explain

## 功能

- SQL被如何执行
- 查询计划（Query Execution Plan）

## 用法

```mysql
EXPLAIN SELECT * FROM users WHERE age > 20;
```

- 使用哪一个Index
  - TYPE
    -  ref  //使用index的检索
    - ALL //全扫描
    - range //范围扫描，MySQL 使用了 **索引**，扫描索引中某个范围的行，而不是全表扫描；LIKE/IN
    - 目标：ALL < range < ref
  - KEY
    - PRIMARY // 使用PrimaryKey作为index的检索
    - 空白 // 没有候补index
  - ROWS: 1//仅读入一行
    - 目标：尽量减少
  - EXTRA
    - 目标：仅肯呢个减少
- 查询哪一个Table
- 整个过程预计会读入多少行

# Process List

## 功能

- 查看 SQL 执行状态
  - 可以用于监控正在执行的查询、线程、锁等情况
- 查询数据库结构和统计信息
  - 使用 `information_schema`（系统级 schema / 命名空间）
  - information_schema 是 MySQL 的系统级 schema，保存数据库元数据
  - 可以用来查询表结构、索引、约束等信息，监控 SQL 状态属于数据库管理的功能

## 用法

```mysql
SELECT * FROM PROCESSLIST

SELECT * FROM PROCESSLIST WHERE INFO <> '' ORDER BY TIME DESC #查看耗时最长的SQLs
```



## 注意

- 直接查询 information_schema 全部表 → 可能慢，甚至不可 kill

- 使用中仅仅使用其中的一些表

  | Table       | 作用                         |
  | ----------- | ---------------------------- |
  | PROCESSLIST | 查看当前正在执行的线程和 SQL |
  | TABLES      | 查看数据库中表的基本信息     |
  | COLUMNS     | 查看表的列信息               |
  | STATISTICS  | 查看索引信息                 |
  | SCHEMATA    | 查看数据库列表               |

- 其中 PROCESSLIST（或 SHOW PROCESSLIST）最常用

  - 用来监控当前执行的 SQL、锁等待等
  - 开销小，不会导致数据库卡死

# Show Engine InnoDB Status

## 功能

- 数据库 “存储引擎” 下的概念
  - Storage Engine = 表背后的“存储和操作机制”
  - 决定 **事务支持、索引类型、锁策略、性能和可靠性**
  - MySQL 支持 多存储引擎，不同表可以用不同引擎
- MySQL中的存储引擎
  - 可以对每个表指定不同的Storage Engine（MyISAM/InnoDB）
  - InnoDB → 支持事务、外键、行级锁
  - MyISAM → 不支持事务，但查询速度快，适合日志或归档表

## 用法

```mysql
Show Engine Innodb Status
```

- 最常使用的是DEADLOCK —— LATEST DETECTED DEADLOCK（MySQL 已检测到循环等待，必须回滚）
  - table name
    - 死锁涉及的表名
  - Lock Mode
    - X lock => 排他锁，事务独占该行
    - S lock => 共享锁，允许读但不允许写
  - Lock --- 死锁涉及的锁对象
    - Record Lock => 行级锁，锁定具体行
    - Gap Lock => 锁定行之间的“间隙”，防止幻读（phantom read）
-  死锁 vs 长时间锁等待
  - 死锁（Deadlock）：两个或多个事务互相等待对方释放锁，形成循环依赖，永远无法完成
  - 锁等待（Lock Wait / Long Lock）：一个事务持有锁时间过长，其他事务等待，但如果持锁事务最终完成，等待事务就能继续 → 并不是死锁
